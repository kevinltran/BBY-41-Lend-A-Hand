<!DOCTYPE html>
<html>

<head>
  <title>Geolocation</title>
  <meta name="viewport" content="initial-scale=1.0, user-scalable=no">
  <meta charset="utf-8">
  <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/css/bootstrap.min.css"
    integrity="sha384-Vkoo8x4CGsO3+Hhxv8T/Q5PaXtkKtu6ug5TOeNV6gBiFeWPGFN9MuhOf23Q9Ifjh" crossorigin="anonymous">
  <style>
    /* Always set the map height explicitly to define the size of the div
       * element that contains the map. */
    #map {
      height: 100%;
      height: 400px;
      width: 1000px;
      left: 25%;
    }

    .slider {
      -webkit-appearance: none;
      width: 100%;
      height: 15px;
      border-radius: 5px;  
      background: #d3d3d3;
      outline: none;
      opacity: 0.7;
      -webkit-transition: .2s;
      transition: opacity .2s;
    }

    .slider::-webkit-slider-thumb {
      -webkit-appearance: none;
      appearance: none;
      width: 25px;
      height: 25px;
      border-radius: 50%; 
      background: #4CAF50;
      cursor: pointer;
    }

    .slider::-moz-range-thumb {
      width: 25px;
      height: 25px;
      border-radius: 50%;
      background: #4CAF50;
      cursor: pointer;
    }

    .slider:hover {
    opacity: 1; /* Fully shown on mouse-over */
  }

    /* Optional: Makes the sample page fill the window. */
    /*html, body {
        height: 100%;
        margin: 0;
        padding: 0;
      }*/
  </style>
</head>

<body>
  <script src="https://www.gstatic.com/firebasejs/7.9.2/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/7.9.2/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/7.9.2/firebase-firestore.js"></script>
  <script src="https://cdn.firebase.com/libs/firebaseui/3.5.2/firebaseui.js"></script>
  <script src="../scripts/firebase.js"></script>
  <script src="https://code.jquery.com/jquery-3.4.1.slim.min.js"
    integrity="sha384-J6qa4849blE2+poT4WnyKhv5vZF5SrPo0iEjwBvKU7imGFAV0wwj1yYfoRSJoZ+n"
    crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.0/dist/umd/popper.min.js"
    integrity="sha384-Q6E9RHvbIyZFJoft+2mJbHaEWldlvI9IOYy5n3zV9zzTtmI3UksdQRVvoxMfooAo"
    crossorigin="anonymous"></script>
  <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/js/bootstrap.min.js"
    integrity="sha384-wfSDF2E50Y2D1uUdj0O3uMBJnjuUD4Ih7YwaYd1iqfktj0Uod8GCExl3Og8ifwB6"
    crossorigin="anonymous"></script>
  <script async defer
    src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAdQNsdN8jh2Tv1Ot0ADsbRqbzlUMYQXEU&callback=initMap">
    </script>
  <div id="map" class="rounded-circle"></div>
  <div class="slidecontainer">
    <input type="range" min="0" max="20" value="10" class="slider" id="rangeSlider">
    <p>Distance: <span id="distance"></span></p>
  </div>
  <script>
    // Note: This example requires that you consent to location sharing when
    // prompted by your browser. If you see the error "The Geolocation service
    // failed.", it means you probably did not give permission for the browser to
    // locate you.
    var map, infoWindow;
    function initMap() {
      map = new google.maps.Map(document.getElementById('map'), {
        center: { lat: -34.397, lng: 150.644 },
        zoom: 9
      });
      infoWindow = new google.maps.InfoWindow;

      // Try HTML5 geolocation.
      if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(function (position) {
          var pos = {
            lat: position.coords.latitude,
            lng: position.coords.longitude
          };
          //testing marker
          var marker = new google.maps.Marker({
            position: pos,
            map: map
          })
          infoWindow.setPosition(pos);
          infoWindow.setContent('You are here.');
          infoWindow.open(map);
          map.setCenter(pos);

          //testing radius circle
          var radiusCircle /*= new google.maps.Circle({
            strokeColor: '#FF0000',
            strokeOpacity: 0.8,
            strokeWeight: 2,
            fillColor: '#FF0000',
            fillOpacity: 0.35,
            map: map,
            center: pos,
            radius: parseInt(document.getElementById("rangeSlider").value) * 1000,
          })*/
        }, function () {
          handleLocationError(true, infoWindow, map.getCenter());
        });
      } else {
        // Browser doesn't support Geolocation
        handleLocationError(false, infoWindow, map.getCenter());
      }

      ///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

      let directionsService = new google.maps.DirectionsService();
      //let directionsRenderer = new google.maps.DirectionsRenderer();
      //directionsRenderer.setMap(map); // Existing map object displays directions
      // Create route from existing points used for markers
      firebase.auth().onAuthStateChanged(function (user) {
        if (user) {
          db.collection("users").doc(user.uid).get().then(function (snap) {
            // console.log(snap.data().address);
            // console.log(snap.data().city);
            // console.log(snap.data().postalCode);
            let locationInfo = snap.data().address + snap.data().city + snap.data().postalCode;
            // console.log(locationInfo);
            db.collection("users").get().then(function (snapshot) {
              snapshot.forEach(function (doc) {
                if (doc.data().role == "helpee") {
                  // console.log(doc.data().address);
                  // console.log(doc.data().city);
                  // console.log(doc.data().postalCode);
                  let helpeeLocation = doc.data().address + doc.data().city + doc.data().postalCode;
                  const route = {
                    origin: locationInfo,
                    destination: helpeeLocation,
                    travelMode: 'DRIVING'
                  }

                  directionsService.route(route,
                    function (response, status) { // anonymous function to capture directions
                      if (status !== 'OK') {
                        window.alert('Directions request failed due to ' + status);
                        return;
                      } else {
                        //directionsRenderer.setDirections(response); // Add route to the map
                        var directionsData = response.routes[0].legs[0]; // Get data about the mapped route
                        if (!directionsData) {
                          window.alert('Directions request failed');
                          return;
                        }
                        else {
                          console.log(doc.data().name);//document.getElementById('msg').innerHTML += " Driving distance is " + directionsData.distance.text + " (" + directionsData.duration.text + ").";
                        }
                      }
                    });
                }
              })
            })
          })
        }
      })
    }

    function handleLocationError(browserHasGeolocation, infoWindow, pos) {
      infoWindow.setPosition(pos);
      infoWindow.setContent(browserHasGeolocation ?
        'Error: The Geolocation service failed.' :
        'Error: Your browser doesn\'t support geolocation.');
      infoWindow.open(map);
    }

    /*function radiusCircle(){
      let radiusCircle = new google.maps.Circle({
            strokeColor: '#FF0000',
            strokeOpacity: 0.8,
            strokeWeight: 2,
            fillColor: '#FF0000',
            fillOpacity: 0.35,
            map: map,
            center: pos,
            radius: parseInt(document.getElementById("rangeSlider").value) * 1000,
          })
    }*/

    let slider = document.getElementById("rangeSlider");
    let display = document.getElementById("distance");
    display.innerHTML = slider.value;

    slider.oninput = function(){
      display.innerHTML = this.value + "km";
      /*var newRad = this.value * 1000;
      if(!radiusCircle || !radiusCircle.setRadius){
        radiusCircle = new google.maps.Circle({
          strokeColor: '#FF0000',
          strokeOpacity: 0.8,
          strokeWeight: 2,
          fillColor: '#FF0000',
          fillOpacity: 0.35,
        });
        radiusCircle.bindTo('center', marker, "position");
      } else circle.setRadius(rad);*/
    }
  </script>
</body>

</html>